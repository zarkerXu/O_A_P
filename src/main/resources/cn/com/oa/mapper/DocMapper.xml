<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.oa.mapper.DocMapper" >
<resultMap id="Doc" type="cn.com.oa.model.Doc">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 20 17:32:57 CST 2015.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="department" jdbcType="VARCHAR" property="department" />
    <result column="personnel" jdbcType="VARCHAR" property="department" />
    <result column="level" jdbcType="INTEGER" property="level" />
    <result column="docNo" jdbcType="VARCHAR" property="docNo" />
    <result column="docTitle" jdbcType="VARCHAR" property="docTitle" />
    <result column="docSummary" jdbcType="VARCHAR" property="docSummary" />
    <result column="signNum" jdbcType="INTEGER" property="signNum" />
    <result column="signStatus" jdbcType="INTEGER" property="signStatus" />
    <result column="isuse" jdbcType="INTEGER" property="isuse" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="cuid" jdbcType="VARCHAR" property="cuid" />
    <result column="createTime" jdbcType="TIMESTAMP" property="createTime" />
    <result column="uuid" jdbcType="VARCHAR" property="uuid" />
    <result column="updataTime" jdbcType="TIMESTAMP" property="updataTime" />
    <result column="oldid" jdbcType="VARCHAR" property="oldid"/>
    <result column="relayRemark" jdbcType="VARCHAR" property="relayRemark"/>
    
    
  </resultMap>
<!--  删除记录  -->  
    <delete id="delete" parameterType="String">
       delete from doc where id in (${value})
    </delete> 
    <update id="deleteupdate" parameterType="String">
    	update doc set isuse=1 where id in (${value})
    </update>
    <update id="update" parameterType="Doc">
    update doc
    <set>
    <if test="level !=null">
    level=#{level},
    </if>
    <if test="docNo !=null and docNo !=''">
    docNo=#{docNo},
    </if>
    <if test="docTitle !=null and docTitle !=''">
    docTitle=#{docTitle},
    </if>
    <if test="docSummary !=null and docSummary !=''">
    docSummary=#{docSummary},
    </if>
    <if test="signNum !=null">
    signNum=#{signNum},
    </if>
    <if test="signStatus !=null">
    signStatus=#{signStatus},
    </if>
    <if test="isuse !=null">
    isuse=#{isuse},
    </if>
    <if test="remark !=null and remark !=''">
    remark=#{remark},
    </if>
    <if test="uuid !=null and uuid !=''">
    uuid=#{uuid},
    </if>
    <if test="updataTime !=null and updataTime !=''">
    updataTime=#{updataTime}
    </if>
    </set>
    where id=#{id}
    </update>

 <select id="select" parameterType="String" resultType="Doc">
    select d.* ,(select GROUP_CONCAT(o.name) from sys_organization o where FIND_IN_SET(o.id,d.department)) as departmentInfo from doc d where d.id=#{id} 
    </select>
    <select id="findByParameter" parameterType="Doc" resultType="Doc">
    select * from doc
    <where>
    isuse=0
    <if test="id!=null and id!=''">
    and id=#{id}
    </if>
    <if test="level !=null">
    and level=#{level}
    </if>
    <if test="docNo !=null and docNo !=''">
    and docNo=#{docNo}
    </if>
    <if test="docTitle !=null and docTitle !=''">
    and docTitle=#{docTitle}
    </if>
    <if test="docSummary !=null and docSummary !=''">
    and docSummary=#{docSummary}
    </if>
    <if test="signNum !=null">
    and signNum=#{signNum}
    </if>
    <if test="signStatus !=null">
    and signStatus=#{signStatus}
    </if>
    <if test="isuse !=null">
    and isuse=#{isuse}
    </if>
    <if test="remark !=null and remark !=''">
    and remark=#{remark}
    </if>
    <if test="cuid !=null and cuid !=''">
    and cuid=#{cuid}
    </if>
    <if test="createTime !=null and createTime !=''">
    and createTime=#{createTime}
    </if>
    <if test="uuid !=null and uuid !=''">
    and uuid=#{uuid}
    </if>
    <if test="updataTime !=null and updataTime !=''">
    and updataTime=#{updataTime}
    </if>
    </where>
    <if test="orderBy !=null and orderBy !=''">
    order by ${orderBy}
    </if>
    </select>
    
<select id="findByParameterToPage" parameterType="Page" resultType="Doc">  <!--parameterType:传进去的type,resultType:传出来的type-->
    select *,(select o.name from sys_organization o join sys_user u on u.oid=o.id where u.id=d.cuid) as sendDepartmentInfo,(select  group_concat(name) from sys_organization where FIND_IN_SET(  id, d.department)) as departmentInfo 
    ,if(signStatus=0,signNum,(select count(*) from d_task t where t.did=d.id and t.type=1 and t.signStatus=0)) as didtask from doc d
    <where>
    isuse=0
    <if test="pageObject.id!=null and pageObject.id!=''">
    and id=#{pageObject.id}
    </if>
    <if test="pageObject.level !=null">
    and level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.isuse !=null">
    and isuse=#{pageObject.isuse}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="userids !=null and userids !=''">
    and cuid in  (${userids})
    </if>
    </where>
    <if test="pageObject.orderBy !=null and pageObject.orderBy !=''">
    order by ${pageObject.orderBy}
    </if>
    limit #{Before},#{size}
    </select>
    
    <select id="findByParameterToPages" parameterType="Page" resultType="Integer">  
    select count(*) from doc
    <where>
    isuse=0
    <if test="pageObject.id!=null and pageObject.id!=''">
    and id=#{pageObject.id}
    </if>
    <if test="pageObject.level !=null">
    and level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="userids !=null and userids !=''">
    and cuid in  (${userids})
    </if>
    </where>
    </select>
     <select id="findByTaskToPage" parameterType="Page" resultType="Doc">
     select t.id as tid,d.id,d.level,d.docNo,d.docTitle,d.docSummary,d.personnel,t.signStatus,d.remark,d.createTime,(select o.name from sys_organization o join sys_user u on u.oid=o.id where u.id=d.cuid) as sendDepartmentInfo from  d_task t join doc d on d.id=t.did 
     <where>
     t.type=1
     and d.remark is NULL
     and d.isuse=0
     and (t.uid=#{userids} or (t.oid=(select oid from sys_user where id=#{userids}) and t.uid is null and t.signStatus=1 and 0=(select ismain from sys_user where id=#{userids})) )
     <if test="pageObject.id !=null and pageObject.id !=''">
    and d.id=#{pageObject.id}
    </if>
     <if test="pageObject.level !=null">
    and d.level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and d.docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and d.docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and d.docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and d.signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and d.signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and d.remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and d.cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and d.uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
     </where>
     order by t.signStatus desc,d.createTime desc 
     limit #{Before},#{size}
     </select>
     
     <select id="findByTaskToPageCount" parameterType="Page" resultType="Integer">
     select count(*) from  d_task t join doc d on d.id=t.did 
     <where>
     t.type=1
     and d.remark is NULL
     and d.isuse=0
     and (t.uid=#{userids} or (t.oid=(select oid from sys_user where id=#{userids}) and t.uid is null and t.signStatus=1 and 0=(select ismain from sys_user where id=#{userids})) )
     <if test="pageObject.id !=null and pageObject.id !=''">
    and d.id=#{pageObject.id}
    </if>
     <if test="pageObject.level !=null">
    and d.level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and d.docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and d.docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and d.docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and d.signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and d.signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and d.remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and d.cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and d.uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
     </where>
     </select>
    
    <select id="findByUserToPage" parameterType="Page" resultType="Doc"> 
    select *,(select o.name from sys_organization o join sys_user u on u.oid=o.id where u.id=d.cuid) as sendDepartmentInfo,(select  group_concat(name) from sys_organization where FIND_IN_SET(  id, d.department)) as departmentInfo 
    ,if(signStatus=0,signNum,(select count(*) from d_task t where t.did=d.id and t.type=1 and t.signStatus=0)) as didtask from doc d
    <where>
    isuse=0
    and remark is null
    <if test="pageObject.id!=null and pageObject.id!=''">
    and id=#{pageObject.id}
    </if>
    <if test="pageObject.level !=null">
    and level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.isuse !=null">
    and isuse=#{pageObject.isuse}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
    and cuid =#{userids}
    </where>
    <if test="pageObject.orderBy !=null and pageObject.orderBy !=''">
    order by ${pageObject.orderBy}
    </if>
    limit #{Before},#{size}
    </select>
    <select id="findByUserToPageCount" parameterType="Page" resultType="Integer">  
    select count(*) from doc d
    <where>
    isuse=0
    and remark is null
    <if test="pageObject.id!=null and pageObject.id!=''">
    and id=#{pageObject.id}
    </if>
    <if test="pageObject.level !=null">
    and level=#{pageObject.level}
    </if>
    <if test="pageObject.docNo !=null and pageObject.docNo !=''">
    and docNo like #{pageObject.docNo}
    </if>
    <if test="pageObject.docTitle !=null and pageObject.docTitle !=''">
    and docTitle like #{pageObject.docTitle}
    </if>
    <if test="pageObject.docSummary !=null and pageObject.docSummary !=''">
    and docSummary=#{pageObject.docSummary}
    </if>
    <if test="pageObject.signNum !=null">
    and signNum=#{pageObject.signNum}
    </if>
    <if test="pageObject.signStatus !=null">
    and signStatus=#{pageObject.signStatus}
    </if>
    <if test="pageObject.isuse !=null">
    and isuse=#{pageObject.isuse}
    </if>
    <if test="pageObject.remark !=null and pageObject.remark !=''">
    and remark=#{pageObject.remark}
    </if>
    <if test="pageObject.cuid !=null and pageObject.cuid !=''">
    and cuid=#{pageObject.cuid}
    </if>
    <if test="pageObject.uuid !=null and pageObject.uuid !=''">
    and uuid=#{pageObject.uuid}
    </if>
    <if test="startTime !=null and startTime !=''">
    and d.createTime &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d %H:%i:%S')
    </if>
    <if test="endTime !=null and endTime !=''">
    and d.createTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
    </if>
    and cuid =#{userids}
    </where>
    </select>
    
    <select id="findIdByParameter" parameterType="Doc" resultType="String">
    select id from doc
    <where>
    isuse=0
    and level=#{level}
    and docNo=#{docNo}
    and docTitle=#{docTitle}
    and docSummary=#{docSummary}
    </where>
    </select>
    
    <select id="isSign" parameterType="String" resultType="Boolean">
    select if(signNum=(select count(*) from d_task where did=d.id and signStatus=0),true,false) as a from doc d where id=(select did from  d_task where id=#{tid} and type=1)
    </select>
    

    <insert id="insert" parameterType="Doc">
      insert into doc(id,department,personnel,level,docNo,docTitle,docSummary,signNum,signStatus,isuse,remark,cuid,createTime) values(#{id},#{department,jdbcType=VARCHAR},#{personnel,jdbcType=VARCHAR},#{level},#{docNo,jdbcType=VARCHAR},#{docTitle,jdbcType=VARCHAR},#{docSummary,jdbcType=VARCHAR},#{signNum},1,0,#{remark,jdbcType=VARCHAR},#{cuid},#{createTime})
    </insert>
    
    <insert id="copyInsert" parameterType="Doc">
      insert into doc(id,department,personnel,level,docNo,docTitle,docSummary,signNum,signStatus,isuse,remark,cuid,createTime,oldid,relayRemark) select #{id},department,#{personnel,jdbcType=VARCHAR},level,docNo,docTitle,docSummary,#{signNum},1,0,#{remark,jdbcType=VARCHAR},#{cuid},#{createTime} ,#{oldid},#{relayRemark} from doc where id=#{tid}
    </insert>
    
    
</mapper>